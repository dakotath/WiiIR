// Wii IR
// A homebrew implementation of what the TV Friend Channel did, but with more support.

// LSB First - X100001Y ; X is the first bit, Y is the last bit.
// MSB First - X100001Y ; Y is the first bit, X is the last bit.

// FIXME:   Fix and verify Samsung32 protocol.
// TODO:    Implement and verify: ITT, JVC, NRC17, RC6, RCMM, RECS80, SHARP, and XSAT.
// TODO:    Adjust timing and verify for RC5, SIRC(12,15,20).
// TODO:    Implement a way to calculate correct timings for RAW command types.
// TODO:    Adjust database and enumerators to allow for new protocols.

/*
    NEC Protocol Notes:
        16 bit address version, 8 bit command. (Only command checksum included).
        8  bit adddress version, 8 bit command (Address and command checksum included).
        Pulse distance modulation.
        Carrier frequency of 38KHz.
        Bit time of 1.125ms or 2.25ms.
        LSB First.

    SIRC Protocol Notes:
        12-bit version, 7 command bits, 5 address bits.
        15-bit version, 7 command bits, 8 address bits.
        20-bit version, 7 command bits, 5 address bits, 8 extended bits.
        Pulse width modulation.
        Carrier frequency of 40kHz.
        Bit time of 1.2ms or 0.6ms.
        LSB First.
*/


/*
 * Copyright 2025 Dakota Thorpe and Larsen Vallecillo
 *
 * This file is part of the Wii IR project.
 *
 * Permission is hereby granted to view the source code of this project for informational purposes only.
 *
 * The following rights are explicitly prohibited for all individuals and entities except Dakota Thorpe 
 * and Larsen Vallecillo:
 * - Copying
 * - Modifying
 * - Distributing
 * - Sharing
 * - Using
 *
 * No part of this project may be reproduced, distributed, or transmitted in any form or by any means, 
 * including but not limited to copying, modification, or incorporation into other projects, without 
 * prior written permission from Dakota Thorpe and Larsen Vallecillo.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT 
 * LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, OR NON-INFRINGEMENT. 
 * IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES, OR OTHER LIABILITY, 
 * WHETHER IN AN ACTION OF CONTRACT, TORT, OR OTHERWISE, ARISING FROM, OUT OF, OR IN CONNECTION WITH THE 
 * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
*/

/*
    REFERENCES:
    https://www.sbprojects.net/knowledge/ir/
    https://www.sbprojects.net/knowledge/ir/index.php
    https://www.sbprojects.net/knowledge/ir/itt.php
    https://www.sbprojects.net/knowledge/ir/jvc.php
    https://www.sbprojects.net/knowledge/ir/nec.php
    https://www.sbprojects.net/knowledge/ir/nrc17.php
    https://www.sbprojects.net/knowledge/ir/others.php
    https://www.sbprojects.net/knowledge/ir/rc5.php
    https://www.sbprojects.net/knowledge/ir/rc6.php
    https://www.sbprojects.net/knowledge/ir/rca.php
    https://www.sbprojects.net/knowledge/ir/rcmm.php
    https://www.sbprojects.net/knowledge/ir/recs80.php
    https://www.sbprojects.net/knowledge/ir/sharp.php
    https://www.sbprojects.net/knowledge/ir/sirc.php
    https://www.sbprojects.net/knowledge/ir/universal.php
    https://www.sbprojects.net/knowledge/ir/xsat.php
    https://rusticengineering.wordpress.com/2011/02/09/infrared-room-control-with-samsung-ir-protocol/
    https://tasmota.github.io/docs/IRSend-RAW-Encoding/

    # Hardware
    https://wiibrew.org/wiki/Hardware (Holy crap that site got filled with ads)
*/

#include "imgui.h"
#include "imgui_freetype.h"
#include "imgui_impl_sdl2.h"
#include "imgui_impl_sdlrenderer2.h"
#include "WiiIR/IR.hpp"
#include <stdio.h>

// Font
static_assert(true, "imgui_freetype included");
#include "DroidSans_ttf.h"

#include "tinyxml2.h"
#include <string>
#include <vector>
#include <filesystem>
#include <stdexcept>
#include <iostream>
#include <algorithm>
#include <unordered_map>
#include <unordered_set>

#include <SDL.h>
#ifdef _WIN32
#include <windows.h>        // SetProcessDPIAware()
#endif

#if !SDL_VERSION_ATLEAST(2,0,17)
#error This backend requires SDL 2.0.17+ because of SDL_RenderGeometry() function
#endif

// Christmas Tree Pronto
const u16 tree_power_off[] =      {0x0000, 0x006D, 0x0024, 0x0000, 0x015A, 0x00AF, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x003F, 0x0015, 0x0041, 0x0015, 0x0041, 0x0015, 0x0041, 0x0017, 0x003F, 0x0015, 0x0041, 0x0015, 0x0041, 0x0015, 0x003F, 0x0017, 0x003F, 0x0015, 0x0041, 0x0015, 0x0041, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0017, 0x003F, 0x0017, 0x0015, 0x0015, 0x0015, 0x0015, 0x0017, 0x0015, 0x0017, 0x0015, 0x0041, 0x0015, 0x003F, 0x0017, 0x003F, 0x0017, 0x0017, 0x0013, 0x0041, 0x0015, 0x0602, 0x015C, 0x0057, 0x0015, 0x09D9};
const u16 tree_power_on[] =       {0x0000, 0x006D, 0x0022, 0x0000, 0x0158, 0x00AF, 0x0015, 0x0017, 0x0013, 0x0019, 0x0013, 0x0019, 0x0013, 0x0019, 0x0011, 0x0019, 0x0013, 0x0019, 0x0013, 0x0019, 0x0013, 0x0017, 0x0013, 0x0043, 0x0013, 0x0043, 0x0013, 0x0043, 0x0013, 0x0043, 0x0013, 0x0043, 0x0011, 0x0043, 0x0013, 0x0043, 0x0015, 0x0041, 0x0015, 0x0041, 0x0013, 0x0019, 0x0013, 0x0041, 0x0015, 0x0017, 0x0013, 0x0019, 0x0013, 0x0019, 0x0013, 0x0043, 0x0011, 0x0019, 0x0013, 0x0019, 0x0013, 0x0043, 0x0013, 0x0019, 0x0011, 0x0043, 0x0013, 0x0043, 0x0015, 0x0041, 0x0013, 0x0019, 0x0013, 0x0043, 0x0011, 0x09D9};
const u16 tree_bright_up[] =      {0x0000, 0x006D, 0x0022, 0x0000, 0x0158, 0x00AF, 0x0015, 0x0019, 0x0013, 0x0017, 0x0013, 0x0019, 0x0013, 0x0019, 0x0013, 0x0017, 0x0013, 0x0019, 0x0013, 0x0019, 0x0013, 0x0017, 0x0015, 0x0041, 0x0015, 0x0041, 0x0013, 0x0041, 0x0015, 0x0041, 0x0015, 0x0043, 0x0013, 0x0041, 0x0015, 0x0041, 0x0013, 0x0043, 0x0015, 0x0015, 0x0015, 0x0041, 0x0015, 0x0017, 0x0015, 0x0041, 0x0015, 0x0015, 0x0015, 0x0017, 0x0015, 0x0041, 0x0015, 0x0017, 0x0015, 0x0041, 0x0013, 0x0019, 0x0013, 0x0041, 0x0015, 0x0017, 0x0015, 0x0041, 0x0015, 0x003F, 0x0015, 0x0019, 0x0013, 0x0041, 0x0015, 0x09D9};
const u16 tree_bright_down[] =    {0x0000, 0x006D, 0x0024, 0x0000, 0x015C, 0x00AD, 0x0017, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0017, 0x003F, 0x0015, 0x0041, 0x0015, 0x003F, 0x0017, 0x003F, 0x0015, 0x0041, 0x0015, 0x0041, 0x0015, 0x0041, 0x0015, 0x0041, 0x0015, 0x0017, 0x0015, 0x003F, 0x0015, 0x0019, 0x0013, 0x0017, 0x0015, 0x0017, 0x0015, 0x0017, 0x0013, 0x0041, 0x0017, 0x0015, 0x0015, 0x003F, 0x0017, 0x0017, 0x0015, 0x003F, 0x0017, 0x003F, 0x0015, 0x0041, 0x0015, 0x003F, 0x0017, 0x0017, 0x0015, 0x003F, 0x0017, 0x0602, 0x015A, 0x0057, 0x0017, 0x09D9};
const u16 tree_mode_1[] =         {0x0000, 0x006D, 0x0022, 0x0000, 0x015A, 0x00AF, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0017, 0x0015, 0x003F, 0x0017, 0x003F, 0x0017, 0x003F, 0x0015, 0x0041, 0x0015, 0x0041, 0x0015, 0x0041, 0x0015, 0x0041, 0x0015, 0x003F, 0x0017, 0x003F, 0x0017, 0x003F, 0x0015, 0x0041, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0017, 0x0013, 0x0017, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0015, 0x003F, 0x0017, 0x003F, 0x0017, 0x003F, 0x0017, 0x003F, 0x0017, 0x003F, 0x0017, 0x09D9};
const u16 tree_mode_2[] =         {0x0000, 0x006D, 0x0022, 0x0000, 0x015A, 0x00B1, 0x0013, 0x0017, 0x0013, 0x0019, 0x0013, 0x0019, 0x0013, 0x0019, 0x0011, 0x001B, 0x0013, 0x0015, 0x0015, 0x0019, 0x0011, 0x0019, 0x0015, 0x0041, 0x0013, 0x0043, 0x0013, 0x0043, 0x0013, 0x0043, 0x0013, 0x0043, 0x0011, 0x0043, 0x0013, 0x0043, 0x0015, 0x0041, 0x0013, 0x0043, 0x0013, 0x0019, 0x0013, 0x0043, 0x0011, 0x0019, 0x0013, 0x0043, 0x0013, 0x0019, 0x0013, 0x0019, 0x0011, 0x0019, 0x0013, 0x0019, 0x0013, 0x0043, 0x0013, 0x0019, 0x0011, 0x0043, 0x0013, 0x0019, 0x0013, 0x0043, 0x0013, 0x0043, 0x0013, 0x0043, 0x0013, 0x09D9};
const u16 tree_mode_3[] =         {0x0000, 0x006D, 0x0022, 0x0000, 0x0158, 0x00B1, 0x0013, 0x0017, 0x0015, 0x0017, 0x0013, 0x0019, 0x0013, 0x0019, 0x0013, 0x0019, 0x0011, 0x0019, 0x0013, 0x0017, 0x0015, 0x0019, 0x0013, 0x0041, 0x0013, 0x0043, 0x0013, 0x0043, 0x0013, 0x0043, 0x0013, 0x0041, 0x0015, 0x0043, 0x0013, 0x0041, 0x0013, 0x0043, 0x0013, 0x0043, 0x0013, 0x0019, 0x0013, 0x0019, 0x0013, 0x0043, 0x0011, 0x0019, 0x0013, 0x0019, 0x0013, 0x0017, 0x0015, 0x0017, 0x0013, 0x0019, 0x0013, 0x0041, 0x0015, 0x0041, 0x0015, 0x0017, 0x0015, 0x0041, 0x0015, 0x0041, 0x0013, 0x0041, 0x0015, 0x0043, 0x0013, 0x09D9};
const u16 tree_mode_4[] =         {0x0000, 0x006D, 0x0022, 0x0000, 0x015C, 0x00AD, 0x0015, 0x0015, 0x0017, 0x0015, 0x0017, 0x0015, 0x0015, 0x0015, 0x0017, 0x0015, 0x0017, 0x0015, 0x0017, 0x0015, 0x0015, 0x0015, 0x0017, 0x003F, 0x0017, 0x003F, 0x0017, 0x003F, 0x0015, 0x0041, 0x0015, 0x0041, 0x0015, 0x003F, 0x0017, 0x003F, 0x0017, 0x003F, 0x0017, 0x0015, 0x0015, 0x0041, 0x0015, 0x003F, 0x0017, 0x0015, 0x0017, 0x003F, 0x0017, 0x0015, 0x0015, 0x0015, 0x0017, 0x0015, 0x0015, 0x0041, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x003F, 0x0017, 0x0015, 0x0015, 0x0041, 0x0015, 0x003F, 0x0017, 0x003F, 0x0017, 0x09D9};
const u16 tree_mode_5[] =         {0x0000, 0x006D, 0x0022, 0x0000, 0x015A, 0x00AF, 0x0013, 0x0019, 0x0013, 0x0019, 0x0013, 0x0017, 0x0013, 0x0019, 0x0015, 0x0017, 0x0013, 0x0019, 0x0013, 0x0017, 0x0015, 0x0017, 0x0013, 0x0043, 0x0013, 0x0043, 0x0013, 0x0043, 0x0013, 0x0041, 0x0015, 0x0041, 0x0013, 0x0043, 0x0013, 0x0043, 0x0013, 0x0043, 0x0013, 0x0043, 0x0013, 0x0017, 0x0015, 0x0017, 0x0013, 0x0043, 0x0013, 0x0041, 0x0015, 0x0019, 0x0013, 0x0017, 0x0015, 0x0017, 0x0013, 0x0017, 0x0015, 0x0043, 0x0011, 0x0043, 0x0015, 0x0017, 0x0013, 0x0019, 0x0013, 0x0043, 0x0013, 0x0041, 0x0015, 0x0041, 0x0015, 0x09D9};
const u16 tree_mode_6[] =         {0x0000, 0x006D, 0x0022, 0x0000, 0x015C, 0x00AF, 0x0015, 0x0015, 0x0015, 0x0017, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0015, 0x0015, 0x0017, 0x0015, 0x0041, 0x0015, 0x0041, 0x0015, 0x0041, 0x0015, 0x003F, 0x0017, 0x003F, 0x0015, 0x0041, 0x0015, 0x0041, 0x0015, 0x0041, 0x0015, 0x0041, 0x0015, 0x0015, 0x0015, 0x0041, 0x0015, 0x0041, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0017, 0x0015, 0x003F, 0x0015, 0x0017, 0x0015, 0x0017, 0x0015, 0x0041, 0x0015, 0x003F, 0x0017, 0x003F, 0x0015, 0x0041, 0x0015, 0x09D9};
const u16 tree_mode_7[] =         {0x0000, 0x006D, 0x0022, 0x0000, 0x015C, 0x00AD, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x003F, 0x0017, 0x003F, 0x0017, 0x003F, 0x0017, 0x003F, 0x0015, 0x003F, 0x0017, 0x003F, 0x0017, 0x003F, 0x0017, 0x003F, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x003F, 0x0017, 0x003F, 0x0017, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x003F, 0x0015, 0x003F, 0x0017, 0x0015, 0x0017, 0x0015, 0x0017, 0x003F, 0x0017, 0x003E, 0x0017, 0x003F, 0x0017, 0x003F, 0x0017, 0x09D9};
const u16 tree_mode_8[] =         {0x0000, 0x006D, 0x0022, 0x0000, 0x015E, 0x00AD, 0x0017, 0x0013, 0x0017, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0015, 0x0015, 0x0017, 0x003F, 0x0017, 0x003F, 0x0017, 0x003F, 0x0017, 0x003F, 0x0015, 0x003F, 0x0017, 0x003F, 0x0017, 0x003F, 0x0017, 0x003F, 0x0017, 0x0015, 0x0015, 0x0015, 0x0017, 0x0015, 0x0015, 0x0041, 0x0017, 0x003F, 0x0017, 0x0015, 0x0015, 0x0015, 0x0017, 0x0015, 0x0017, 0x003F, 0x0017, 0x003F, 0x0015, 0x003F, 0x0017, 0x0015, 0x0017, 0x0015, 0x0017, 0x003F, 0x0015, 0x0041, 0x0015, 0x003F, 0x0017, 0x09D9};
const u16 tree_mode_9[] =         {0x0000, 0x006D, 0x0022, 0x0000, 0x015A, 0x00AF, 0x0013, 0x0019, 0x0013, 0x0017, 0x0015, 0x0017, 0x0013, 0x0019, 0x0013, 0x0017, 0x0015, 0x0017, 0x0015, 0x0017, 0x0013, 0x0019, 0x0013, 0x0041, 0x0013, 0x0043, 0x0015, 0x0041, 0x0013, 0x0043, 0x0013, 0x0041, 0x0015, 0x0041, 0x0015, 0x0041, 0x0013, 0x0043, 0x0013, 0x0019, 0x0013, 0x0043, 0x0013, 0x0043, 0x0013, 0x0041, 0x0015, 0x0041, 0x0013, 0x0019, 0x0013, 0x0043, 0x0013, 0x0019, 0x0013, 0x0043, 0x0011, 0x0019, 0x0015, 0x0017, 0x0013, 0x0017, 0x0013, 0x0019, 0x0013, 0x0043, 0x0013, 0x0019, 0x0013, 0x0041, 0x0015, 0x09D9};
const u16 tree_mode_10[] =        {0x0000, 0x006D, 0x0022, 0x0000, 0x015A, 0x00AF, 0x0015, 0x0017, 0x0015, 0x0015, 0x0015, 0x0017, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0015, 0x0017, 0x0015, 0x0015, 0x0015, 0x0041, 0x0017, 0x003F, 0x0015, 0x0041, 0x0015, 0x0041, 0x0015, 0x0041, 0x0015, 0x003F, 0x0017, 0x003F, 0x0017, 0x003F, 0x0017, 0x0015, 0x0015, 0x0015, 0x0017, 0x0015, 0x0015, 0x0041, 0x0017, 0x0015, 0x0015, 0x0015, 0x0015, 0x0017, 0x0015, 0x0017, 0x0015, 0x0041, 0x0015, 0x003F, 0x0017, 0x003F, 0x0017, 0x0015, 0x0017, 0x003F, 0x0015, 0x0041, 0x0015, 0x0041, 0x0015, 0x003F, 0x0015, 0x09D9};
const u16 tree_mode_11[] =        {0x0000, 0x006D, 0x0022, 0x0000, 0x015A, 0x00AF, 0x0013, 0x0017, 0x0015, 0x0017, 0x0015, 0x0017, 0x0013, 0x0017, 0x0015, 0x0017, 0x0015, 0x0017, 0x0015, 0x0017, 0x0013, 0x0017, 0x0015, 0x0041, 0x0015, 0x0041, 0x0013, 0x0043, 0x0013, 0x0043, 0x0015, 0x0041, 0x0013, 0x0041, 0x0015, 0x0041, 0x0015, 0x0041, 0x0015, 0x0017, 0x0013, 0x0043, 0x0015, 0x0015, 0x0015, 0x0041, 0x0015, 0x0041, 0x0015, 0x0017, 0x0015, 0x0041, 0x0013, 0x0017, 0x0015, 0x0041, 0x0015, 0x0017, 0x0015, 0x0041, 0x0015, 0x0015, 0x0015, 0x0019, 0x0013, 0x0043, 0x0011, 0x0019, 0x0015, 0x0041, 0x0015, 0x09D9};

// Command Lengths
size_t tree_power_off_len = sizeof(tree_power_off) / sizeof(tree_power_off[0]);
size_t tree_power_on_len = sizeof(tree_power_on) / sizeof(tree_power_on[0]);
size_t tree_bright_up_len = sizeof(tree_bright_up) / sizeof(tree_bright_up[0]);
size_t tree_bright_down_len = sizeof(tree_bright_down) / sizeof(tree_bright_down[0]);
size_t tree_mode_1_len = sizeof(tree_mode_1) / sizeof(tree_mode_1[0]);
size_t tree_mode_2_len = sizeof(tree_mode_2) / sizeof(tree_mode_2[0]);
size_t tree_mode_3_len = sizeof(tree_mode_3) / sizeof(tree_mode_3[0]);
size_t tree_mode_4_len = sizeof(tree_mode_4) / sizeof(tree_mode_4[0]);
size_t tree_mode_5_len = sizeof(tree_mode_5) / sizeof(tree_mode_5[0]);
size_t tree_mode_6_len = sizeof(tree_mode_6) / sizeof(tree_mode_6[0]);
size_t tree_mode_7_len = sizeof(tree_mode_7) / sizeof(tree_mode_7[0]);
size_t tree_mode_8_len = sizeof(tree_mode_8) / sizeof(tree_mode_8[0]);
size_t tree_mode_9_len = sizeof(tree_mode_9) / sizeof(tree_mode_9[0]);
size_t tree_mode_10_len = sizeof(tree_mode_10) / sizeof(tree_mode_10[0]);
size_t tree_mode_11_len = sizeof(tree_mode_11) / sizeof(tree_mode_11[0]);

// Menu struct
typedef struct {
    const char* command_name;
    const u16 *cmd_ptr;
    size_t cmd_len;
} menustruct_t;

// Menu
menustruct_t menu[15] = {
    (menustruct_t){"Power On", tree_power_on, tree_power_on_len},
    (menustruct_t){"Power Off", tree_power_off, tree_power_off_len},
    (menustruct_t){"Brightness Up", tree_bright_up, tree_bright_up_len},
    (menustruct_t){"Brightness Down", tree_bright_down, tree_bright_down_len},
    (menustruct_t){"Tree Mode 1", tree_mode_1, tree_mode_1_len},
    (menustruct_t){"Tree Mode 2", tree_mode_2, tree_mode_2_len},
    (menustruct_t){"Tree Mode 3", tree_mode_3, tree_mode_3_len},
    (menustruct_t){"Tree Mode 4", tree_mode_4, tree_mode_4_len},
    (menustruct_t){"Tree Mode 5", tree_mode_5, tree_mode_5_len},
    (menustruct_t){"Tree Mode 6", tree_mode_6, tree_mode_6_len},
    (menustruct_t){"Tree Mode 7", tree_mode_7, tree_mode_7_len},
    (menustruct_t){"Tree Mode 8", tree_mode_8, tree_mode_8_len},
    (menustruct_t){"Tree Mode 9", tree_mode_9, tree_mode_9_len},
    (menustruct_t){"Tree Mode 10", tree_mode_10, tree_mode_10_len},
    (menustruct_t){"Tree Mode 11", tree_mode_11, tree_mode_11_len}
};

// Main code
int main(int, char**)
{
    StartUI();
    XMLDatabase db = LoadXML("database.xml", "custom_maps.xml");

    // Get IO
    ImGuiIO& io = ImGui::GetIO(); (void)io;

    // Add the main font
    ImFontConfig cfg;
    cfg.FontDataOwnedByAtlas = false;
    io.Fonts->AddFontFromMemoryTTF((void*)DroidSans_ttf, DroidSans_ttf_size, 16.0f, &cfg);
    io.Fonts->Build();

    // Our state
    ImVec4 clear_color = ImVec4(0.25f, 0.5f, 0.5f, 1.00f);

    // Main loop
    bool done = false;
    ImGuiWindowFlags window_flags;
    ImGuiViewport* viewport = ImGui::GetMainViewport();
    while (!done)
    {
        // Poll and handle events (inputs, window resize, etc.)
        SDL_Event event;
        while (SDL_PollEvent(&event))
        {
            ImGui_ImplSDL2_ProcessEvent(&event);
            if (event.type == SDL_QUIT)
                done = true;
            if (event.type == SDL_WINDOWEVENT && event.window.event == SDL_WINDOWEVENT_CLOSE && event.window.windowID == SDL_GetWindowID(window))
                done = true;
        }
        if (SDL_GetWindowFlags(window) & SDL_WINDOW_MINIMIZED)
        {
            SDL_Delay(10);
            continue;
        }

        // Start the Dear ImGui frame
        ImGui_ImplSDLRenderer2_NewFrame();
        ImGui_ImplSDL2_NewFrame();
        ImGui::NewFrame();

        // Render the main XML Browser
        ImGui::SetNextWindowPos(viewport->Pos);
        ImGui::SetNextWindowSize(viewport->Size);
        //ImGui::SetNextWindowViewport(viewport->ID);

        window_flags |= ImGuiWindowFlags_None;

        // remove rounding/border
        ImGui::PushStyleVar(ImGuiStyleVar_WindowRounding, 0.0f);
        ImGui::PushStyleVar(ImGuiStyleVar_WindowBorderSize, 0.0f);
        ImGui::PushStyleVar(ImGuiStyleVar_ChildRounding, 8.0f);
        DrawXMLBrowser(db, window_flags);
        ImGui::PopStyleVar(3);

        // Rendering
        ImGui::Render();
        SDL_RenderSetScale(renderer, io.DisplayFramebufferScale.x, io.DisplayFramebufferScale.y);
        SDL_SetRenderDrawColor(renderer, (Uint8)(clear_color.x * 255), (Uint8)(clear_color.y * 255), (Uint8)(clear_color.z * 255), (Uint8)(clear_color.w * 255));
        SDL_RenderClear(renderer);
        ImGui_ImplSDLRenderer2_RenderDrawData(ImGui::GetDrawData(), renderer);
        SDL_RenderPresent(renderer);
    }

    // Cleanup
    ImGui_ImplSDLRenderer2_Shutdown();
    ImGui_ImplSDL2_Shutdown();
    ImGui::DestroyContext();

    SDL_DestroyRenderer(renderer);
    SDL_DestroyWindow(window);
    SDL_Quit();

    return 0;
}
